<!DOCTYPE html>
<html> 
<head>
<meta http-equiv="content-type" content="charset=utf-8"></meta>
<title>Insert title here</title>
<script src="/resources/static/js/jquery-3.3.1.min.js"></script>
<script src="/resources/static/js/jquery.jsonp-2.4.0.js"></script>
<script  type="text/javascript">
	var page = 1;//第几页开始
	var maxPage = 377;//第几页结束
	var content = "\uFEFF";
	
	$(document).ready(function(){
		  $("#iframe1").attr("height",$(window).height()*1.0);
		});
	
	var url="http://www.mabangerp.com/index.php?mod=order.orderSearch";
	data={"CustomitemsPurchaseflag":"1",
			"PHPSESSID":"98bob6ffnt4p6a5gsg3duq06k1",
			"signed":"176851_a23a58b88ab52636ab54be0a6aa5b297",
			"page":page,
			"loginCookie":"a%3A2%3A%7Bs%3A8%3A%22username%22%3Bs%3A6%3A%22176851%22%3Bs%3A9%3A%22passsword%22%3Bs%3A32%3A%2224cb0f4b3d71ed5936c54ed6eb90dbfe%22%3B%7D"};
	function getInfo(){	
		 alert(123);
	     todo();
	 }
	function getHeight(){
		return $(window).height()*0.8;
	}
	function todo3(){
		$.ajax({
		    async: false,
		    type: "GET",
		    dataType: 'jsonp',
		    //jsonp: 'callback',
		    //jsonpCallback: 'callbackfunction',
		    url: url,
		    data: data,
		    timeout: 3000,
		    contentType: "application/json;utf-8",
		    success: function(data) {
		    	 console.log(data);
                 alert(222);
                 const theData = JSON.parse(data);
                 console.log("加载第",page,"页数据",",共"+(theData.pageCount/50)+"页",status);
                 if(status == "success"){
                     const orders = theData.orderDataList;
                     orders.forEach(function(order){
                         order.orderItem_data_list.forEach(function(sku){
                             if(sku.warehouseName == "上海自建仓-澄建路"){
                                 content += ([""+order.salesRecordNumber,sku.stockSku,sku.quantity,sku.hasGoods==1?'有货':'没货'].join(','));
                                 content += "\n";
                             }
                         });
                     });                
                     if(page <![CDATA[ '<' ]]> maxPage){
                         page++;
                         todo();
                     }else{
                         console.log("数据抓取完成，开始下载文件");
                         var csvData = new Blob([content], { type: 'text/csv' });
                         var a = document.createElement('a');
                         a.href = URL.createObjectURL(csvData);
                         a.target = '_blank';
                         a.download = 'info.csv';
                         document.body.appendChild(a);
                         console.log(a);
                         a.click();
                         document.body.removeChild(a);
                     } 
                 };  
           }}
		  );
	}
	function todo(){
		$.jsonp({  
			   url:url,  
			   data:data,  
			   callbackParameter:"callback",  
			   timeout:3000,  
			   dataFilter:function(json){  
			   //console.log("jsonp.filter:"+json.name);  
			   json.name = "测试12";
			   //console.log(json);
			return json;  
			},  
			  success:function(data,status){  
	               // console.log(data);
	                alert(222);
	                 const theData = JSON.parse(data);
	                 console.log("加载第",page,"页数据",",共"+(theData.pageCount/50)+"页",status);
	                 if(status == "success"){
	                     const orders = theData.orderDataList;
	                     orders.forEach(function(order){
	                         order.orderItem_data_list.forEach(function(sku){
	                             if(sku.warehouseName == "上海自建仓-澄建路"){
	                                 content += ([""+order.salesRecordNumber,sku.stockSku,sku.quantity,sku.hasGoods==1?'有货':'没货'].join(','));
	                                 content += "\n";
	                             }
	                         });
	                     });                
	                     if(page <![CDATA[ '<' ]]> maxPage){
	                         page++;
	                         todo();
	                     }else{
	                         console.log("数据抓取完成，开始下载文件");
	                         var csvData = new Blob([content], { type: 'text/csv' });
	                         var a = document.createElement('a');
	                         a.href = URL.createObjectURL(csvData);
	                         a.target = '_blank';
	                         a.download = 'info.csv';
	                         document.body.appendChild(a);
	                         console.log(a);
	                         a.click();
	                         document.body.removeChild(a);
	                     } 
	                 };  
			   },  
			   error:function(xOptions,textStatus){  
			    console.log("jsonp.error:"+textStatus+", rel="+xOptions.data.rel);  
			   }  
			}); 
	}
	
	function todo2(){
		$.ajax({url,
	        data:data,
	        dataType: 'jsonp',
	        jsonp: "callback",
	        jsonpCallback:"success_jsonp",
	        scriptCharset: 'utf-8',  
	        crossDomain: true,
	        success: function(data){
	        	var status="success";
	        	console.log(data);
	        	
	             const theData = JSON.parse(data);
	             console.log("加载第",page,"页数据",",共"+(theData.pageCount/50)+"页",status);
	             if(status == "success"){
	                 const orders = theData.orderDataList;
	                 orders.forEach(function(order){
	                     order.orderItem_data_list.forEach(function(sku){
	                         if(sku.warehouseName == "上海自建仓-澄建路"){
	                             content += ([""+order.salesRecordNumber,sku.stockSku,sku.quantity,sku.hasGoods==1?'有货':'没货'].join(','));
	                             content += "\n";
	                         }
	                     });
	                 });                
	                 if(page <![CDATA[ '<' ]]> maxPage){
	                     page++;
	                     todo();
	                 }else{
	                     console.log("数据抓取完成，开始下载文件");
	                     var csvData = new Blob([content], { type: 'text/csv' });
	                     var a = document.createElement('a');
	                     a.href = URL.createObjectURL(csvData);
	                     a.target = '_blank';
	                     a.download = 'info.csv';
	                     document.body.appendChild(a);
	                     console.log(a);
	                     a.click();
	                     document.body.removeChild(a);
	                 } 
	             }	     
	      }
		});
	}
	
	
	 
	 function todo1(){
         try{
         $.get("http://www.mabangerp.com/index.php?mod=order.orderSearch",data,
         function(data,status){
             const theData = JSON.parse(data);
             console.log("加载第",page,"页数据",",共"+(theData.pageCount/50)+"页",status);
             if(status == "success"){
                 const orders = theData.orderDataList;
                 orders.forEach(function(order){
                     order.orderItem_data_list.forEach(function(sku){
                         if(sku.warehouseName == "上海自建仓-澄建路"){
                             content += ([""+order.salesRecordNumber,sku.stockSku,sku.quantity,sku.hasGoods==1?'有货':'没货'].join(','));
                             content += "\n";
                         }
                     });
                 });                
                 if(page <![CDATA[ '<' ]]> maxPage){
                     page++;
                     todo();
                 }else{
                     console.log("数据抓取完成，开始下载文件");
                     var csvData = new Blob([content], { type: 'text/csv' });
                     var a = document.createElement('a');
                     a.href = URL.createObjectURL(csvData);
                     a.target = '_blank';
                     a.download = 'info.csv';
                     document.body.appendChild(a);
                     console.log(a);
                     a.click();
                     document.body.removeChild(a);
                 } 
             }
         });
         }catch(e){
             console.log(e);
         }
        } 
</script>
</head>
<body>
    <input type="button" onclick="getInfo()" value="请点击"/>
    <iframe id="iframe1" width="100%" height="300px" src="http://www.mabangerp.com/index.htm" scrolling="auto">
    </iframe>
</body>
</html>